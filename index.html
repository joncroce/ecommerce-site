<!DOCTYPE html>
<html>

<head>
	<title>E-Commerce Site</title>
	<style>
		/* Reset */
		*,
		*::before,
		*::after {
			box-sizing: border-box;
		}

		h1,
		h2,
		h3,
		h4 {
			margin: 0;
		}

		body {
			display: grid;
			place-items: center;
		}

		/* Reset styling from button defaults */
		.category__wrapper,
		.product__wrapper {
			padding: 0;
			border: none;
		}

		.category__wrapper:focus-visible,
		.product__wrapper:focus-visible {
			outline: 2px solid hotpink;
			outline-offset: -3px;
		}

		.menu {
			padding: 0;
			display: grid;
			grid-auto-rows: auto;
			gap: 2px;
			border: 2px solid #333;
			background-color: #333;
			width: clamp(320px, 100%, 640px);
		}

		.category__wrapper {
			display: grid;
			grid-auto-rows: auto;
			gap: 1px;
			background-color: #777;
			cursor: pointer;
		}

		.category__wrapper[aria-expanded="false"]>.category__title::after {
			content: ' \25B2';
		}

		.category__wrapper[aria-expanded="true"]>.category__title::after {
			content: ' \25BC';
		}

		.category__wrapper[aria-expanded="false"]>.product__wrapper {
			display: none;
		}

		.category__title {
			padding-block: 0.5rem;
			font-size: 1.5rem;
			font-weight: 600;
			text-align: center;
			background-color: #DDD;
		}

		.product__wrapper {
			padding: 0.5rem 0.25rem;
			display: grid;
			grid-template-columns: 2rem auto;
			gap: 0.25rem;
			background-color: #FFF;
			cursor: pointer;
		}

		.product__wrapper:hover .product__sale-price,
		.product__wrapper:focus-visible .product__sale-price {
			visibility: visible;
		}

		.product__wrapper:hover .product__price,
		.product__wrapper:focus-visible .product__price {
			text-decoration: line-through;
		}

		.product__favorited {
			grid-column: 1 / span 1;
			font-size: 1.2rem;
		}

		.product__title {
			grid-column: 2 / span 1;
			font-size: 1.1rem;
			text-align: left;
		}

		.product__price-wrapper {
			grid-column: 2 / span 1;
			font-size: 1.1rem;
			text-align: left;
		}

		.product__price-label {}

		.product__price {}

		.product__sale-price {
			padding-inline: 0.5em;
			visibility: hidden;
		}

		.heart-inner {
			opacity: 0;
		}

		.product__wrapper[data-favorited="true"] .heart-inner {
			opacity: 1;
		}
	</style>
</head>

<body>
</body>

<noscript>Please enable JavaScript to view this site.</noscript>

<script>
	(async () => {
		const productsData = await fetchProducts();
		const menuEl = createMenu(productsData);
		document.body.appendChild(menuEl);
	})();

	async function fetchProducts() {
		const url = 'https://neodigm.github.io/FED_Programming_Challenge/products.json';
		let data = [];
		try {
			await fetch(url)
				.then(res => { data = res.json() });
		} catch (e) {
			console.error(e?.message ?? 'Error retrieving product data.');
		}

		return data;
	}

	function createMenu(productsData = []) {
		const menuEl = createMenuEl();
		const favoritedProductIds = getFavoritedProductIds();
		const productsByCategory = groupProductsByCategory(productsData);

		productsByCategory.forEach((products, category) =>
			buildCategoryAndAppendToMenu(products, category, favoritedProductIds, menuEl)
		);

		return menuEl;
	}

	function createMenuEl() {
		const menuEl = document.createElement('section');
		menuEl.classList.add('menu');

		return menuEl;
	}

	function groupProductsByCategory(productsData = []) {
		const productsByCategory = new Map();

		productsData.forEach((product) => {
			const category = product.cat;
			const title = product.product;
			const price = parseInt(product.price);
			const salePrice = parseInt(product.sale);
			const id = `${category}_${title}`;

			if (productsByCategory.has(category)) {
				productsByCategory.set(category, [...productsByCategory.get(category), { id, title, price, salePrice }])
			} else {
				productsByCategory.set(category, [{ id, title, price, salePrice }]);
			}
		});

		return productsByCategory;
	}

	function createCategoryWrapperEl() {
		const categoryWrapperEl = document.createElement('button');
		categoryWrapperEl.classList.add('category__wrapper');
		categoryWrapperEl.setAttribute('type', 'button');
		categoryWrapperEl.setAttribute('aria-expanded', 'false');
		categoryWrapperEl.addEventListener('click', categoryClickHandler);

		return categoryWrapperEl;
	}

	function createCategoryTitleEl(category) {
		const categoryTitleEl = document.createElement('h2');
		categoryTitleEl.classList.add('category__title');
		categoryTitleEl.innerText = category;

		return categoryTitleEl;
	}

	function buildCategoryAndAppendToMenu(products, category, favoritedProductIds, menuEl) {
		const categoryWrapperEl = createCategoryWrapperEl();
		const categoryTitleEl = createCategoryTitleEl(category);

		categoryWrapperEl.appendChild(categoryTitleEl);

		products
			.map((product) => addIsFavoritedProperty(product, favoritedProductIds))
			.forEach((product) => buildProductAndAppendToCategory(product, categoryWrapperEl));

		menuEl.appendChild(categoryWrapperEl);
	}

	function buildProductAndAppendToCategory(productData, categoryWrapperEl) {
		const { id, title, price, salePrice, isFavorited } = productData;

		const productWrapperEl = createProductWrapperEl(id, isFavorited);
		const productTitleEl = createProductTitleEl(title);
		const productFavoriteEl = createProductFavoriteEl();
		const productPriceWrapperEl = createProductPriceWrapperEl();
		const productPriceLabelEl = createProductPriceLabelEl();
		const productPriceEl = createProductPriceEl(price);
		const productSalePriceEl = createProductSalePriceEl(salePrice);

		productPriceWrapperEl.appendChild(productPriceLabelEl);
		productPriceWrapperEl.appendChild(productPriceEl);
		productPriceWrapperEl.appendChild(productSalePriceEl);

		productWrapperEl.appendChild(productFavoriteEl);
		productWrapperEl.appendChild(productTitleEl);
		productWrapperEl.appendChild(productPriceWrapperEl);
		categoryWrapperEl.appendChild(productWrapperEl);
	}

	function addIsFavoritedProperty(product, favoritedProductIds) {
		return { ...product, isFavorited: favoritedProductIds.includes(product.id) }
	}

	function createProductWrapperEl(id, isFavorited) {
		const productWrapperEl = document.createElement('button');
		productWrapperEl.classList.add('product__wrapper');
		productWrapperEl.setAttribute('type', 'button');
		productWrapperEl.setAttribute('data-favorited', isFavorited);
		productWrapperEl.addEventListener('click', productClickHandler);

		return productWrapperEl;
	}

	function createProductTitleEl(title = '') {
		const productTitleEl = document.createElement('div');
		productTitleEl.classList.add('product__title');
		productTitleEl.innerText = title;
		return productTitleEl;
	}

	function createProductFavoriteEl() {
		/**
		 * Using icon ph:heart-straight-duotone from the Phosphor collection
		 * https://github.com/phosphor-icons/web
		 */
		const productFavoriteEl = document.createElement('div');
		productFavoriteEl.classList.add('product__favorited');
		productFavoriteEl.innerHTML = `
					<svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 256 256">
						<g fill="#888888">
							<path class="heart-inner" d="M217.36 133.36L128 224l-89.36-90.64a50 50 0 0 1 70.72-70.72L128 80l18.64-17.36a50 50 0 1 1 70.72 70.72Z" />
							<path d="M223 57a58.07 58.07 0 0 0-81.92-.1L128 69.05l-13.09-12.19A58 58 0 0 0 33 139l89.35 90.66a8 8 0 0 0 11.4 0L223 139a58 58 0 0 0 0-82Zm-11.35 70.76L128 212.6l-83.7-84.92a42 42 0 0 1 59.4-59.4l.2.2l18.65 17.35a8 8 0 0 0 10.9 0l18.65-17.35l.2-.2a42 42 0 1 1 59.36 59.44Z"/>
						</g>
					</svg>
				`;

		return productFavoriteEl;
	}

	function createProductPriceWrapperEl() {
		const productPriceWrapperEl = document.createElement('div');
		productPriceWrapperEl.classList.add('product__price-wrapper');

		return productPriceWrapperEl;
	}

	function createProductPriceLabelEl() {
		const productPriceLabelEl = document.createElement('span');
		productPriceLabelEl.classList.add('product__price-label');
		productPriceLabelEl.innerText = 'Price: ';

		return productPriceLabelEl;
	}

	function createProductPriceEl(price) {
		const formattedPrice = formatPrice(price);
		const productPriceEl = document.createElement('span');
		productPriceEl.classList.add('product__price');
		productPriceEl.innerText = formattedPrice;

		return productPriceEl;
	}

	function createProductSalePriceEl(salePrice) {
		const formattedPrice = formatPrice(salePrice);
		const productSalePriceEl = document.createElement('span');
		productSalePriceEl.classList.add('product__sale-price');
		productSalePriceEl.innerText = formattedPrice;

		return productSalePriceEl;
	}

	function formatPrice(price) {
		return isNaN(price)
			? 'N/A'
			: price.toFixed(2);
	}

	function getFavoritedProductIds() {
		const favoritedProductIds = localStorage.getItem('favoritedProductIds');

		return favoritedProductIds ? JSON.parse(favoritedProductIds) : [];
	}

	function categoryClickHandler(e) {
		const isExpanded = e.currentTarget.getAttribute('aria-expanded');
		e.currentTarget.setAttribute('aria-expanded', isExpanded === 'true' ? 'false' : 'true');
	}

	function productClickHandler(e) {
		e.stopPropagation();
		const isFavorited = e.currentTarget.getAttribute('data-favorited') === 'true';
		const newValue = isFavorited ? 'false' : 'true';
		e.currentTarget.setAttribute('data-favorited', newValue);

		const favoritedProductIds = getFavoritedProductIds();
		setFavoritedProductIds(
			newValue === 'true'
				? [...favoritedProductIds, id]
				: favoritedProductIds.filter((val) => val !== id)
		);
	}

	function setFavoritedProductIds(favoritedProductIds) {
		localStorage.setItem('favoritedProductIds', JSON.stringify(favoritedProductIds));
	}
</script>

</html>